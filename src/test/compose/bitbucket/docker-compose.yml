# docker-compose --project-name bitbucket
version: "3.0"

services:
  web:
    domainname: example.com
    hostname: bitbucket
    image: nginx:1
    depends_on:
      - pki
    links:
      - app:app
    ports:
      - 80:80
      - 443:443
    restart: on-failure
    volumes:
      - pki:/etc/ssl/private
      - cache:/var/cache/nginx
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro

  app:
    build:
      context: ../../../..
    environment:
      CATALINA_CONNECTOR_PROXYNAME: "bitbucket.example.com"
      CATALINA_CONNECTOR_PROXYPORT: "443"
      CATALINA_CONNECTOR_SCHEME: "https"
      CATALINA_CONNECTOR_SECURE: "true"
    domainname: example.com
    hostname: bitbucket
    image: atlassian/bitbucket-server:4.2
    depends_on:
      - home
    links:
      - db:db
    ports:
      - 7999:7999
    volumes:
      - home:/var/atlassian/application-data/bitbucket
      - ./bitbucket.properties:/var/atlassian/application-data/bitbucket/shared/bitbucket.properties:ro

  db:
    image: postgres:9.4
    environment:
      POSTGRES_USER: bitbucket
      POSTGRES_PASSWORD: bitbucket
    volumes:
      - data:/var/lib/postgresql/data

  home:
    image: atlassian/bitbucket-server:4.2
    command: |
      /bin/sh -c '/bin/sh -s << EOF
        mkdir -vp $$BITBUCKET_HOME/shared
        chown -v $$RUN_USER:$$RUN_GROUP $$BITBUCKET_HOME
        chown -v $$RUN_USER:$$RUN_GROUP $$BITBUCKET_HOME/shared
      EOF
      '
    user: "root:root"
    volumes:
      - home:/var/atlassian/application-data/bitbucket

  pki:
    image: alpine
    environment:
      CERT_SUBJECT: "${CERT_SUBJECT-/C=US/ST=California/L=San Francisco/O=example.com/OU=bitbucket.example.com/CN=bitbucket.example.com/emailAddress=bitbucket@example.com}"
    command: |
      /bin/sh -c '/bin/sh -s << EOF
        type openssl || apk add --no-cache openssl
        if [ ! -e server.crt ] || [ ! -e server.key ]; then
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout server.key -out server.crt -subj "$$CERT_SUBJECT"
        fi
      EOF
      '
    volumes:
      - pki:/etc/ssl/private
    working_dir: /etc/ssl/private

volumes:
  data:
    # external:
    #   name: bitbucket-data
  home:
    # external:
    #   name: bitbucket-home
  cache:
    # external:
    #   name: bitbucket-nginx-cache
  pki:
    # external:
    #   name: bitbucket-pki
